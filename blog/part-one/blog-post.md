# Firebase Authentication .NET 5

## Hashtags

dotnet, google, firebase, authentication, webapi, vscode  

Security has always been one of my major concerns when developing applications, especially in web development where our resources can be consumed from everywhere (and potentially from anyone). Be able to restrict the resources' access to only certain people is foundamental.  
Nowadays data loss, identity theft and other cyber threats are constantly increasing. So, in order to reduce this probability that could lead to a business failure, we must write secure and reliable code in our daily development life.
If all of this is a concern also for you I encourage u read carefully this blog post (that will be the first of a series of three).

## The big picture
Throughout this series we're going to build a web api project that supports two authentication providers: Google Firebase and our web api itself. The user, in order to access the web api resource, must be authenticated either against the former or against the latter authentication providers. If this is the case the user will receive a 200 OK response together with the requested data. Otherwise, it will receive a 401 Unauthorized response with no data. The authentication mechanism would be the token authentication in JWT format.  
To maintain the blog post leaner I decided to split this building process into three parts. 
## The first piece
In this blog post we're gonna to create a web api project, create some requests to test it, configure stuff related to Firebase in our web api proj, use the Firebase console to accomplish stuff and implement the Firebase authentication mechanism in our web api. 
## Preamble
This will be a demo application to show off how do things. U can take these concepts and adapt them to your real-world requirements. I'm not going to follow every best practices to save time but I'll do my best to spot things that are not "real-world ready" to use.  
As always, if u get in trouble in following this tutorial u can check the final solution in Github at this [link](https://github.com/ivan-pesenti/auth-series)
## Let's start
After these necessary thoughts we can start the fun part, what everybody are waiting for... the coding!
### Prerequisites
To follow this tutorial u must prepare your machine with some tools and programs:
1. NET 5 Runtime. U can download from [here](https://dotnet.microsoft.com/download/dotnet/5.0)
1. Visual Studio Code (u can use another IDE if u wish). Download can be found [here](https://code.visualstudio.com/download)
1. Postman (u can use another program to consume REST-api if u wish). Download can be found [here](https://www.postman.com/downloads/)
1. Google Firebase project with a user registered.  
NOTE: u must be sure that Email/Password Sign-in method is enabled. When u create a Firebase project it's not enabled by defalt. The correct config is the same as in the below image:  

<p align="center">
    <img src="https://github.com/ivan-pesenti/auth-series/blob/main/blog/part-one/img/fb-sign-in-methods.png?raw=true" alt="firebase sign-in methods" width="700px">
</p>

### Setup web api proj
First, we must create a web api proj. I'll do these kind of stuff from dotnet CLI. So open up a terminal (or use the one integrated in VSCode) and issue:   
`dotnet new webapi -n "AuthSeries"`  
When VSCode will prompt u to restore dependencies give a yes and go ahead.
### Test it
Now to be sure that everything looks fine before start to edit we're going to give it a first try.  
Change directory with `cd AuthSeries` and run the web api with the command `dotnet run`. By default the web api will be launched on port 5001 for HTTPS protocol.  
Open up Postman and create a request with the following params:  
1. HTTP method: GET
1. URL: https://localhost:5001/weatherforecast  

Hit "Send" and u should receive dummy data generated by our web api.
## Firebase stuff
Open your Firebase project within the Google Firebase Console.  
NOTE: to be sure URL of your project should something like 'https://console.firebase.google.com/u/0/xxxxxxx'.
### Create Web App
Click on the little gear next to "Project overview" and select "Project settings". In "General" tab scroll toward the bottom and click the icon in the following image:

<p align="center">
    <img src="https://github.com/ivan-pesenti/auth-series/blob/main/blog/part-one/img/fb-web-app.png?raw=true" alt="firebase web app registration" width="700px">
</p>

Give a meaningful name, I choose "auth-series-app" to discriminate from the Firebase proj called "auth-series" and click "Register App". After that select "Continue to console".
### Create Service Account Key
In order to manage programmatically our Firebase proj directly inside our web api proj through the Firebase Admin SDK we must generate a secret private key that we'll be used to identify our web api in Firebase scope.  
Go to "Service accounts", "Firebase Admin Sdk" and click "Create service account".  
The following window will appear:

<p align="center">
    <img src="https://github.com/ivan-pesenti/auth-series/blob/main/blog/part-one/img/fb-security-warning.png?raw=true" alt="firebase security warning" width="700px">
</p>

Click "Generate key" and a JSON file will be downloaded on your machine. Keep on hand this file as we're going to use it immediately.
## Wire up Firebase and Web Api
Now, let's connect the dots! We've to create a bridge between Firebase and our web api proj.
### Firebase registration inside our Web Api
Change directory (if u're not already there) with `cd AuthSeries` and issue `mkdir Firebase`. Copy the JSON file downloaded above into this folder. Issue the following command in CLI to add a Nuget package:  
```shell
dotnet add package FirebaseAdmin
```
Open the file Startup.cs and add this `using FirebaseAdmin;` below the other using statements.
Finally add the following code to the ConfigureServices() method of Startup.cs class file:
```csharp
FirebaseApp.Create(new AppOptions
    {
        Credential = GoogleCredential.FromFile(@"C:\Projects\SampleProjects\auth-series\auth-series\AuthSeries\Firebase\auth-series-firebase-adminsdk-rk7k4-4dc58434f2.json")
    });
```
IMPORTANT: u must replace my path with yours. In production u should not hard-coded info in this way. U could use environment variable, .NET User Secrets and so on.
### Add firebase authentication in IOC container
#### appsettings.json 
```json
"Jwt": {
    "Firebase": {
      "ValidIssuer": "https://securetoken.google.com/auth-series",
      "ValidAudience": "auth-series"
    }
}
```

#### Startup.cs


## Final test

## Summary

## What's next
